{% extends "base.html" %} {% block title %}Dashboard{% endblock %} {% block
content %}

<style>
  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  .history-item {
    animation: slideIn 0.5s ease-out forwards;
    opacity: 0;
  }
  .custom-scrollbar::-webkit-scrollbar {
    width: 6px;
  }
  .custom-scrollbar::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 10px;
  }
  .custom-scrollbar::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.2);
    border-radius: 10px;
  }
</style>

<div
  class="flex flex-col md:flex-row justify-between items-end mb-8 animate-fade-in-down"
>
  <div>
    <h1 class="text-4xl font-bold mb-2 tracking-tight">Overview</h1>
    <p class="text-gray-400">
      Cash Flow for <span class="text-cyan-400 font-bold">{{ name }}</span>.
    </p>
  </div>
  <div class="mt-4 md:mt-0">
    <button
      onclick="toggleModal()"
      class="group px-6 py-3 bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-400 hover:to-blue-400 text-white font-bold rounded-lg shadow-lg shadow-cyan-500/20 flex items-center gap-2 transition-all"
    >
      <span
        class="text-xl group-hover:rotate-90 transition-transform duration-300"
        >+</span
      >
      Add Transaction
    </button>
  </div>
</div>

<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
  <div
    class="glass p-8 rounded-2xl relative overflow-hidden flex flex-col justify-between h-96 group"
  >
    <div
      class="absolute right-0 top-0 p-10 opacity-5 text-9xl group-hover:scale-125 group-hover:rotate-12 transition duration-700 ease-in-out cursor-default"
    >
      ‚Çπ
    </div>

    <div>
      <h3
        class="text-gray-400 text-xs font-bold uppercase tracking-widest mb-2"
      >
        Total Liquidity
      </h3>
      <div class="text-5xl lg:text-6xl font-bold text-white tracking-tight">
        ‚Çπ{{ "{:,.2f}".format(balance) }}
      </div>
    </div>

    <div class="space-y-4 relative z-10">
      <div
        class="flex justify-between items-center p-3 rounded-xl bg-white/5 border border-white/5 backdrop-blur-sm"
      >
        <div class="flex items-center gap-3">
          <div
            class="w-8 h-8 rounded-full bg-green-500/20 text-green-400 flex items-center justify-center text-sm shadow-[0_0_10px_rgba(74,222,128,0.2)]"
          >
            ‚á°
          </div>
          <span class="text-sm font-bold text-gray-300">Income</span>
        </div>
        <span class="text-green-400 font-mono font-bold"
          >+‚Çπ{{ "{:,.0f}".format(income) }}</span
        >
      </div>
      <div
        class="flex justify-between items-center p-3 rounded-xl bg-white/5 border border-white/5 backdrop-blur-sm"
      >
        <div class="flex items-center gap-3">
          <div
            class="w-8 h-8 rounded-full bg-red-500/20 text-red-400 flex items-center justify-center text-sm shadow-[0_0_10px_rgba(248,113,113,0.2)]"
          >
            ‚á£
          </div>
          <span class="text-sm font-bold text-gray-300">Expense</span>
        </div>
        <span class="text-red-400 font-mono font-bold"
          >-‚Çπ{{ "{:,.0f}".format(expense) }}</span
        >
      </div>
    </div>
  </div>

  <div class="glass p-6 rounded-2xl h-96 flex flex-col relative">
    <h3 class="text-gray-400 text-xs font-bold uppercase tracking-widest mb-4">
      Outflow Breakdown
    </h3>
    <div class="relative h-full w-full flex items-center justify-center">
      <canvas id="expenseChart"></canvas>
      <div
        class="absolute inset-0 flex items-center justify-center pointer-events-none"
      >
        <div class="text-center mt-4">
          <span class="text-[10px] text-gray-500 uppercase tracking-widest"
            >Total Out</span
          >
          <div class="text-xl font-bold text-white">
            ‚Çπ{{ "{:,.0f}".format(expense) }}
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="glass p-6 rounded-2xl h-96 overflow-y-auto custom-scrollbar">
    <h3
      class="text-gray-400 text-xs font-bold uppercase tracking-widest mb-6 sticky top-0 bg-[#0f172a]/0 backdrop-blur-md py-2 z-10"
    >
      Recent Flow
    </h3>

    <div class="space-y-3 pb-4">
      {% if transactions %} {% for t in transactions %}
      <div
        class="history-item p-3 rounded-xl bg-white/5 border border-white/5 flex justify-between items-center hover:bg-white/10 transition hover:scale-[1.02] cursor-pointer"
        style="animation-delay: {{ loop.index0 * 0.1 }}s"
      >
        <div class="flex items-center gap-3">
          <div
            class="w-8 h-8 rounded-full flex items-center justify-center text-sm shadow-inner
                {{ 'bg-green-500/10 text-green-400 ring-1 ring-green-500/30' if t.type == 'income' else 'bg-red-500/10 text-red-400 ring-1 ring-red-500/30' }}"
          >
            {{ '‚á°' if t.type == 'income' else '‚á£' }}
          </div>
          <div class="overflow-hidden">
            <div class="font-bold text-sm text-white truncate w-28 md:w-24">
              {{ t.description if t.description else t.category }}
            </div>
            <div class="text-[10px] text-gray-500 flex gap-2">
              <span>{{ t.category }}</span>
              <span>‚Ä¢</span>
              <span>{{ t.date.strftime('%b %d') }}</span>
            </div>
          </div>
        </div>

        <div
          class="font-mono text-sm font-bold tracking-tight {{ 'text-green-400' if t.type == 'income' else 'text-red-400' }}"
        >
          {{ '+' if t.type == 'income' else '-' }}‚Çπ{{ "{:,.0f}".format(t.amount)
          }}
        </div>
      </div>
      {% endfor %} {% else %}
      <div
        class="flex flex-col items-center justify-center h-full text-gray-500 text-sm"
      >
        <span class="text-4xl mb-2 opacity-50">üçÉ</span>
        <p>No flow detected yet.</p>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<div class="mb-10">
  <div class="flex justify-between items-center mb-6">
    <h2 class="text-2xl font-bold">Savings Jars</h2>
    <button
      onclick="toggleGoalModal()"
      class="text-cyan-400 text-sm font-bold hover:text-white transition"
    >
      + New Jar
    </button>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
    {% for g in goals %}
    <div
      class="glass relative overflow-hidden rounded-2xl h-64 flex flex-col justify-between p-6 group transition hover:shadow-lg hover:shadow-cyan-500/10"
    >
      <div
        class="absolute bottom-0 left-0 w-full bg-gradient-to-t from-cyan-600/80 to-blue-500/50 transition-all duration-1000 ease-in-out z-0"
        style="height: {{ g.progress() }}%;"
      >
        <div
          class="absolute -top-4 left-0 w-full h-8 bg-blue-500/30 blur-md animate-pulse"
        ></div>
      </div>

      <div class="relative z-10 flex justify-between items-start">
        <div>
          <h3 class="font-bold text-lg drop-shadow-md">{{ g.name }}</h3>
          <p class="text-xs text-gray-300 drop-shadow-md">
            {{ g.progress() }}% Complete
          </p>
        </div>
        <div class="text-right drop-shadow-md">
          <div class="text-xl font-bold">
            ‚Çπ{{ "{:,.0f}".format(g.current_amount) }}
          </div>
          <div class="text-xs text-gray-400">
            of ‚Çπ{{ "{:,.0f}".format(g.target_amount) }}
          </div>
        </div>
      </div>

      <form
        action="{{ url_for('add_funds', goal_id=g.id) }}"
        method="POST"
        class="relative z-10 mt-auto translate-y-20 group-hover:translate-y-0 transition duration-300"
      >
        <div class="flex gap-2">
          <input
            type="number"
            name="amount"
            placeholder="+‚Çπ"
            required
            class="w-full bg-black/60 backdrop-blur-md border border-white/20 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:border-cyan-400 transition"
          />
          <button
            type="submit"
            class="bg-white text-slate-900 px-3 rounded-lg font-bold hover:bg-cyan-400 transition"
          >
            ‚úì
          </button>
        </div>
      </form>
    </div>
    {% endfor %}

    <button
      onclick="toggleGoalModal()"
      class="glass border-2 border-dashed border-gray-700 hover:border-cyan-500/50 rounded-2xl h-64 flex flex-col items-center justify-center text-gray-500 hover:text-cyan-400 transition group hover:bg-white/5"
    >
      <span class="text-4xl mb-2 group-hover:scale-110 transition duration-300"
        >‚öóÔ∏è</span
      >
      <span class="font-bold">Create Jar</span>
    </button>
  </div>
</div>

<div class="mb-10 pb-10">
  <div class="flex justify-between items-center mb-6">
    <div>
      <h2 class="text-2xl font-bold">Subscription Slayer</h2>
      <p class="text-xs text-gray-400">
        Monthly Burn Rate:
        <span class="text-red-400 font-mono font-bold"
          >‚Çπ{{ "{:,.2f}".format(monthly_burn) }}</span
        >
      </p>
    </div>
    <button
      onclick="toggleSubModal()"
      class="text-purple-400 text-sm font-bold hover:text-white transition"
    >
      + Add Contract
    </button>
  </div>

  <div class="flex gap-4 overflow-x-auto custom-scrollbar pb-4">
    {% for sub in subscriptions %}
    <div
      class="min-w-[200px] glass p-5 rounded-xl border-l-4 border-purple-500 relative group"
    >
      <div class="flex justify-between items-start mb-2">
        <div class="text-sm font-bold truncate">{{ sub.name }}</div>
        <div class="text-xs text-gray-500 bg-black/30 px-2 py-1 rounded">
          {{ sub.billing_cycle[0] }}
        </div>
      </div>
      <div class="text-2xl font-mono font-bold text-white">
        ‚Çπ{{ "{:,.0f}".format(sub.amount) }}
      </div>
      <div class="text-[10px] text-gray-400 mt-1 uppercase tracking-wider">
        Auto-Pay
      </div>
      <div
        class="absolute inset-0 bg-purple-500/5 opacity-0 group-hover:opacity-100 transition rounded-xl"
      ></div>
    </div>
    {% endfor %}
    <button
      onclick="toggleSubModal()"
      class="min-w-[150px] glass border-2 border-dashed border-gray-700 flex flex-col items-center justify-center rounded-xl text-gray-500 hover:text-purple-400 transition hover:bg-white/5"
    >
      <span class="text-2xl mb-1">+</span>
      <span class="text-xs font-bold">New Sub</span>
    </button>
  </div>
</div>

<div id="goalModal" class="fixed inset-0 z-50 hidden">
  <div
    class="absolute inset-0 bg-black/90 backdrop-blur-sm"
    onclick="toggleGoalModal()"
  ></div>
  <div
    class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-md"
  >
    <div class="glass p-8 rounded-3xl border border-white/10 shadow-2xl">
      <h2 class="text-2xl font-bold mb-4">New Savings Jar</h2>
      <form action="/add_goal" method="POST" class="space-y-4">
        <input
          type="text"
          name="name"
          placeholder="Goal Name (e.g. Royal Enfield)"
          required
          class="w-full bg-slate-900/50 border border-gray-700/50 rounded-xl p-3 text-white focus:ring-1 focus:ring-cyan-400 outline-none transition"
        />
        <input
          type="number"
          name="target"
          placeholder="Target Amount (‚Çπ)"
          required
          class="w-full bg-slate-900/50 border border-gray-700/50 rounded-xl p-3 text-white focus:ring-1 focus:ring-cyan-400 outline-none transition"
        />
        <button
          type="submit"
          class="w-full py-4 bg-cyan-500 text-slate-900 font-bold rounded-xl hover:bg-cyan-400 transition transform hover:scale-[1.02]"
        >
          Create Jar
        </button>
      </form>
    </div>
  </div>
</div>

<div
  id="transactionModal"
  class="fixed inset-0 z-50 hidden transition-opacity duration-300"
>
  <div
    class="absolute inset-0 bg-black/90 backdrop-blur-sm"
    onclick="toggleModal()"
  ></div>
  <div
    class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-md p-4"
  >
    <div
      class="glass p-8 rounded-3xl border border-white/10 shadow-2xl relative overflow-hidden"
    >
      <div
        class="absolute -top-20 -right-20 w-40 h-40 bg-cyan-500/20 blur-[50px] pointer-events-none"
      ></div>
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold">Log Flow</h2>
        <button
          onclick="toggleModal()"
          class="text-gray-400 hover:text-white text-2xl"
        >
          &times;
        </button>
      </div>

      <form action="/add_transaction" method="POST" class="space-y-4">
        <div class="flex bg-slate-900/50 p-1 rounded-xl">
          <label class="flex-1 text-center cursor-pointer">
            <input
              type="radio"
              name="type"
              value="income"
              class="peer hidden"
            />
            <span
              class="block py-3 rounded-lg text-gray-400 font-medium peer-checked:bg-green-500/20 peer-checked:text-green-400 peer-checked:ring-1 peer-checked:ring-green-500/50 transition"
              >Income</span
            >
          </label>
          <label class="flex-1 text-center cursor-pointer">
            <input
              type="radio"
              name="type"
              value="expense"
              class="peer hidden"
              checked
            />
            <span
              class="block py-3 rounded-lg text-gray-400 font-medium peer-checked:bg-red-500/20 peer-checked:text-red-400 peer-checked:ring-1 peer-checked:ring-red-500/50 transition"
              >Expense</span
            >
          </label>
        </div>

        <div class="space-y-3">
          <div class="relative">
            <span class="absolute left-4 top-3.5 text-gray-500">‚Çπ</span>
            <input
              type="number"
              step="0.01"
              name="amount"
              placeholder="0.00"
              required
              class="w-full bg-slate-900/50 border border-gray-700/50 rounded-xl p-3 pl-8 text-white focus:border-cyan-400 focus:ring-1 focus:ring-cyan-400 outline-none transition font-mono"
            />
          </div>
          <input
            type="text"
            name="description"
            placeholder="Description (e.g. Chai Sutra)"
            required
            class="w-full bg-slate-900/50 border border-gray-700/50 rounded-xl p-3 text-white focus:border-cyan-400 focus:ring-1 focus:ring-cyan-400 outline-none transition"
          />
          <select
            name="category"
            class="w-full bg-slate-900/50 border border-gray-700/50 rounded-xl p-3 text-white focus:border-cyan-400 focus:ring-1 focus:ring-cyan-400 outline-none transition appearance-none"
          >
            <option value="Food">üçî Food & Dining</option>
            <option value="Transport">üöó Transport</option>
            <option value="Shopping">üõçÔ∏è Shopping</option>
            <option value="Entertainment">üé¨ Entertainment</option>
            <option value="Bills">üßæ Bills & Utilities</option>
            <option value="Salary">üí∞ Salary</option>
          </select>
        </div>
        <button
          type="submit"
          class="w-full py-4 mt-2 bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 text-white font-bold rounded-xl shadow-lg shadow-cyan-900/20 transition-all transform hover:scale-[1.02]"
        >
          Confirm
        </button>
      </form>
    </div>
  </div>
</div>

<div id="subModal" class="fixed inset-0 z-50 hidden">
  <div
    class="absolute inset-0 bg-black/90 backdrop-blur-sm"
    onclick="toggleSubModal()"
  ></div>
  <div
    class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-md"
  >
    <div class="glass p-8 rounded-3xl border border-white/10 shadow-2xl">
      <h2 class="text-2xl font-bold mb-4">Track Subscription</h2>
      <form action="/add_subscription" method="POST" class="space-y-4">
        <input
          type="text"
          name="name"
          placeholder="Service Name (e.g. Hotstar)"
          required
          class="w-full bg-slate-900/50 border border-gray-700/50 rounded-xl p-3 text-white focus:ring-1 focus:ring-purple-400 outline-none"
        />

        <div class="flex gap-4">
          <input
            type="number"
            step="0.01"
            name="amount"
            placeholder="Amount (‚Çπ)"
            required
            class="w-full bg-slate-900/50 border border-gray-700/50 rounded-xl p-3 text-white focus:ring-1 focus:ring-purple-400 outline-none"
          />

          <select
            name="cycle"
            class="bg-slate-900/50 border border-gray-700/50 rounded-xl p-3 text-white focus:ring-1 focus:ring-purple-400 outline-none"
          >
            <option value="Monthly">Monthly</option>
            <option value="Yearly">Yearly</option>
          </select>
        </div>

        <button
          type="submit"
          class="w-full py-4 bg-purple-600 text-white font-bold rounded-xl hover:bg-purple-500 transition shadow-lg shadow-purple-900/20"
        >
          Track It
        </button>
      </form>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  // --- CHART LOGIC ---
  const labels = JSON.parse("{{ chart_labels | tojson | safe }}");
  const data = JSON.parse("{{ chart_values | tojson | safe }}");
  const ctx = document.getElementById("expenseChart").getContext("2d");

  if (labels.length > 0) {
    new Chart(ctx, {
      type: "doughnut",
      data: {
        labels: labels,
        datasets: [
          {
            data: data,
            backgroundColor: [
              "#06b6d4",
              "#8b5cf6",
              "#ec4899",
              "#f59e0b",
              "#10b981",
              "#3b82f6",
            ],
            borderWidth: 0,
            hoverOffset: 15,
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        cutout: "75%",
        plugins: {
          legend: {
            position: "bottom",
            labels: {
              color: "#94a3b8",
              font: { size: 10, family: "Outfit" },
              usePointStyle: true,
              boxWidth: 8,
            },
          },
        },
        animation: { animateScale: true, animateRotate: true },
      },
    });
  } else {
    ctx.font = "14px Outfit";
    ctx.fillStyle = "#64748b";
    ctx.textAlign = "center";
    ctx.fillText(
      "No expenses logged",
      ctx.canvas.width / 2,
      ctx.canvas.height / 2
    );
  }

  // --- ALL MODAL FUNCTIONS HERE ---
  function toggleModal() {
    document.getElementById("transactionModal").classList.toggle("hidden");
  }
  function toggleGoalModal() {
    document.getElementById("goalModal").classList.toggle("hidden");
  }
  function toggleSubModal() {
    document.getElementById("subModal").classList.toggle("hidden");
  }
</script>

{% endblock %}
